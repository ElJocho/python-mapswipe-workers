# This is a special configuration file to run tests on Travis-CI via
# GitHub notifications when changes are committed.
#
# For technical details, see http://travis-ci.org/

language: python
python:
  - "3.6"
  - "3.7"
  - "3.8"
virtualenv:
  system_site_packages: true

before_install:
 - pip install --upgrade pip setuptools
 - pip install flake8 black
 # - flake8 --config=mapswipe_workers/setup.cfg mapswipe_workers/mapswipe_workers/*.py
 # - black --check mapswipe_workers/mapswipe_workers/*.py

install:
 - pip install mapswipe_workers/
 - docker build -t mapswipe_postgres postgres/

before_script:
  - mkdir -p ~/.config/mapswipe_workers
  - echo "$serviceAccountKey" > ~/.config/mapswipe_workers/serviceAccountKey.json
  - docker run -d -p 5432:5432 --name mapswipe_postgres -e POSTGRES_DB="$POSTGRES_DB" -e POSTGRES_USER="$POSTGRES_USER" -e POSTGRES_PASSWORD="$POSTGRES_PASSWORD"
  # setup ssh so we can connect to the server from CI runner
  - apk add openssh-client
  - mkdir -p ~/.ssh
  - chmod 700 ~/.ssh
  - eval "$(ssh-agent -s)"
  - export KEY_FILE=~/.ssh/api_server_ssh_key
  - echo "$DEPLOYMENT_SERVER_PRIVATE_KEY" | tr -d '\r' > $KEY_FILE
  - chmod 600 $KEY_FILE
  - ssh-add $KEY_FILE > /dev/null
  - ssh-keyscan -H "$DEPLOYMENT_SERVER_IP" >> ~/.ssh/known_hosts
  - chmod 644 ~/.ssh/known_hosts

script:
  - python -m unittest mapswipe_workers/tests/unittests/test_archive_projects.py
  - ssh -i $KEY_FILE -o StrictHostKeyChecking=no "mapswipe@$DEPLOYMENT_SERVER_IP"
